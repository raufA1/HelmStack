# HelmStack Community Edition - hs runner interface
# Usage: alias hs="make -f Helmfile"

SHELL := /usr/bin/env bash
.SHELLFLAGS := -eo pipefail -c
.DEFAULT_GOAL := help

# hs-specific variables
HS_VERSION := 2.1.0-community
HELMSTACK_ROOT := $(shell pwd)

DOCS_DIR      ?= workspace
INCOMING_DIR  ?= $(DOCS_DIR)/incoming
PROCESSED_DIR ?= $(DOCS_DIR)/processed
PLANS_DIR     ?= $(DOCS_DIR)/plans
RESEARCH_DIR  ?= $(DOCS_DIR)/research
SNAP_DIR      ?= snapshots

NAME ?= $(notdir $(CURDIR))
DESC ?= Project initialized via HelmStack Community Edition
DOC  ?=

# Aliases for common commands
go: start ## ğŸš€ Alias for 'start' - quick project initialization
plan: ## ğŸ§­ Alias for 'fix' - refresh planning documents
	@$(MAKE) fix

start: ## ğŸ”¥ Initialize project with directory structure
	@mkdir -p "$(INCOMING_DIR)" "$(PROCESSED_DIR)" "$(PLANS_DIR)" "$(RESEARCH_DIR)" "$(SNAP_DIR)"
	@if [ -n "$(DOC)" ]; then cp "$(DOC)" "$(INCOMING_DIR)/" && echo "âœ… Added: $(DOC)"; fi
	@if [ ! -d .git ]; then git init && echo "â„¹ï¸ git init"; fi
	@chmod +x scripts/*.sh 2>/dev/null || true
	@if [ ! -f .helmstack_seeded ]; then pre-commit install || true; touch .helmstack_seeded; fi
	@bash scripts/smart_start.sh "$(NAME)" "$(DESC)" "$(DOCS_DIR)" "$(INCOMING_DIR)" "$(PLANS_DIR)"
	@echo "â†’ Next: hs fix | hs work | hs done"

fix: ## ğŸ§­ Refresh plan (basic document analysis)
	@bash scripts/basic_analyzer.sh "$(INCOMING_DIR)" "$(PLANS_DIR)"
	@echo "ğŸ“‹ Basic plan refreshed. For AI-powered analysis, upgrade to HelmStack Pro!"

work: ## ğŸ¯ Build FOCUS_LIST from NEXT_STEPS
	@bash scripts/extract_next_steps.sh "$(PLANS_DIR)"
	@echo "ğŸ¯ Focus list created from next steps"

done: ## ğŸŒ… End of day - basic session wrap-up
	@bash scripts/basic_eod.sh "$(SNAP_DIR)" "$(PLANS_DIR)"
	@echo "âœ… Session completed"

# Core workflow commands
status: ## ğŸ“Š Show current project status
	@sed -n '1,80p' "$(PLANS_DIR)/STATUS.md" 2>/dev/null || echo "No STATUS.md yet - run 'hs fix' first"

next: ## ğŸ“Œ Show next steps
	@sed -n '1,80p' "$(PLANS_DIR)/NEXT_STEPS.md" 2>/dev/null || echo "No NEXT_STEPS.md yet - run 'hs fix' first"

focus: ## ğŸ¯ Show current focus list
	@sed -n '1,80p' "$(PLANS_DIR)/FOCUS_LIST.md" 2>/dev/null || echo "No FOCUS_LIST.md yet - run 'hs work' first"

# Template and documentation
template: ## ğŸ“„ Create template (TYPE=todo|spec|adr FILE=output.md)
	@bash scripts/templates.sh "$(TYPE)" "$(FILE)" || echo "Usage: hs template TYPE=issue FILE=my-issue.md"

adr-new: ## ğŸ“ Create new ADR (TITLE="Decision title")
	@bash scripts/adr.sh new "$(TITLE)" || echo "Usage: hs adr-new TITLE='Use PostgreSQL for database'"

adr-list: ## ğŸ“‹ List all ADRs
	@bash scripts/adr.sh list

# Environment and setup
doctor: ## ğŸ©º Environment diagnostics and health check
	@bash scripts/doctor.sh

demo: ## ğŸ¬ Run interactive demo with sample project
	@bash scripts/demo.sh

setup: ## âš™ï¸ GitHub bootstrap (via gh, optional)
	@bash scripts/bootstrap.sh || true

# Git operations
commit: ## ğŸ“ Commit changes (MSG="commit message")
	@[ -n "$(MSG)" ] || (echo "MSG is required: hs commit MSG='...'" && exit 1)
	@git add -A && git commit -m "$(MSG)"

push: ## â¬†ï¸ Push changes and tags
	@git push || true
	@git push --tags || true

# Repository operations
init: ## ğŸ†• Initialize new HelmStack project (NAME="ProjectName" DESC="Description")
	@echo "ğŸ†• Initializing new HelmStack Community project..."
	@[ -n "$(NAME)" ] || (echo "âŒ NAME is required: hs init NAME='MyProject' DESC='Description'" && exit 1)
	@mkdir -p "$(NAME)"
	@cp -r . "$(NAME)/" 2>/dev/null || true
	@cd "$(NAME)" && rm -rf .git
	@cd "$(NAME)" && git init
	@cd "$(NAME)" && $(MAKE) -f Helmfile start NAME="$(NAME)" DESC="$(DESC)"
	@echo "âœ… New HelmStack Community project '$(NAME)' initialized"
	@echo "ğŸ“‚ Next: cd $(NAME) && hs help"

repo: ## ğŸ—ï¸ Create GitHub repository (NAME="RepoName" DESC="Description" PRIVATE=true/false)
	@echo "ğŸ—ï¸ Creating GitHub repository..."
	@[ -n "$(NAME)" ] || (echo "âŒ NAME is required: hs repo NAME='MyProject' DESC='Description'" && exit 1)
	@if [ "$(PRIVATE)" = "true" ]; then \
		gh repo create --private $(NAME) --description "$(DESC)" --clone=false; \
	else \
		gh repo create --public $(NAME) --description "$(DESC)" --clone=false; \
	fi
	@git remote add origin git@github.com:$(shell gh auth status | grep 'Logged in' | cut -d' ' -f6)/$(NAME).git || true
	@echo "âœ… Repository '$(NAME)' created and remote added"

publish: ## ğŸš€ Initial push to GitHub (creates main branch)
	@echo "ğŸš€ Publishing to GitHub..."
	@git add -A
	@git commit -m "Initial commit via HelmStack Community Edition" || echo "â„¹ï¸  Nothing to commit"
	@git branch -M main
	@git push -u origin main
	@echo "âœ… Published to GitHub on main branch"

# Utility commands
clean: ## ğŸ§¹ Clean generated files
	@rm -rf "$(SNAP_DIR)"/* 2>/dev/null || true
	@find "$(PLANS_DIR)" -name "FOCUS_LIST.md" -delete 2>/dev/null || true
	@echo "Cleaned snapshots and focus list."

version: ## ğŸ“‹ Show HelmStack version
	@echo "ğŸš€ HelmStack Community Edition v$(HS_VERSION)"
	@echo "Document-first project management for open source teams"
	@echo "Repository: https://github.com/raufA1/HelmStack"
	@echo ""
	@echo "ğŸ’¡ Want more features? Upgrade to HelmStack Pro:"
	@echo "   â€¢ AI-powered document analysis"
	@echo "   â€¢ Advanced productivity metrics"
	@echo "   â€¢ Research automation (HITL)"
	@echo "   â€¢ Smart memory management"
	@echo "   Learn more: https://helmstack.dev/pro"

help: ## ğŸ“– Show help message
	@bash scripts/help.sh

# Pro upgrade information
upgrade: ## âœ¨ Learn about HelmStack Pro features
	@echo ""
	@echo "ğŸš€ HelmStack Pro - Supercharge Your Productivity"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ¤– AI-Powered Features:"
	@echo "   â€¢ hs ai-analyze     - AI document analysis"
	@echo "   â€¢ hs ai-memory      - Smart context management"
	@echo "   â€¢ hs ai-commit      - Intelligent commit messages"
	@echo ""
	@echo "ğŸ“Š Advanced Analytics:"
	@echo "   â€¢ hs metrics        - Comprehensive dashboard"
	@echo "   â€¢ hs trends         - Productivity patterns"
	@echo "   â€¢ hs snapshot-diff  - Session comparison"
	@echo ""
	@echo "ğŸ” Research Automation:"
	@echo "   â€¢ hs ask/check/yes/no/end  - Human-in-the-loop research"
	@echo "   â€¢ hs import-docs    - PDF/DOCX conversion"
	@echo ""
	@echo "ğŸŒ Learn more: https://helmstack.dev/pro"
	@echo ""

.PHONY: start go fix work done status next focus template adr-new adr-list doctor demo setup commit push init repo publish clean version help upgrade